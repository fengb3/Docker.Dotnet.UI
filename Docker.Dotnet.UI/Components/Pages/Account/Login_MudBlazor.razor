@page "/Account/LoginMud"
@using Microsoft.AspNetCore.Identity
@using Docker.Dotnet.UI.Database.Models
@using System.ComponentModel.DataAnnotations

@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>登录</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center" Style="min-height: 100vh;">
    <MudPaper Elevation="3" Class="pa-8" Style="width: 100%; max-width: 400px;">
        <MudStack Spacing="4">
            <MudText Typo="Typo.h4" Align="Align.Center">Docker.Dotnet.UI</MudText>
            <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Secondary">用户登录</MudText>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" ShowCloseIcon="true" CloseIconClicked="@(() => errorMessage = null)">
                    @errorMessage
                </MudAlert>
            }

            <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                <DataAnnotationsValidator />
                
                <MudStack Spacing="3">
                    <MudTextField 
                        @bind-Value="loginModel.Username"
                        Label="用户名" 
                        Variant="Variant.Outlined"
                        For="@(() => loginModel.Username)"
                        Disabled="isLoading"
                        T="string" />

                    <MudTextField 
                        @bind-Value="loginModel.Password"
                        Label="密码" 
                        Variant="Variant.Outlined"
                        InputType="InputType.Password"
                        For="@(() => loginModel.Password)"
                        Disabled="isLoading"
                        T="string" />

                    <MudCheckBox 
                        @bind-Value="loginModel.RememberMe"
                        Label="记住我"
                        Color="Color.Primary"
                        Disabled="isLoading"
                        T="bool" />

                    <MudButton 
                        ButtonType="ButtonType.Submit"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        FullWidth="true"
                        Size="Size.Large"
                        Disabled="isLoading">
                        @if (isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">登录中...</MudText>
                        }
                        else
                        {
                            <MudText>登录</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private LoginModel loginModel = new();
    private bool isLoading = false;
    private string? errorMessage;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    // 通过 JavaScript 提交表单到 /api/login 端点
    private async Task HandleLogin()
    {
        // 表单验证通过后，使用 JavaScript 提交表单
        // 这会触发完整的 HTTP POST，避免 Blazor Server 的 Cookie 限制
        await JSRuntime.InvokeVoidAsync("submitLoginForm", 
            loginModel.Username, 
            loginModel.Password, 
            loginModel.RememberMe,
            string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl);
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "用户名不能为空")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "密码不能为空")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }
}

<script>
    window.submitLoginForm = function(username, password, rememberMe, returnUrl) {
        // 创建隐藏表单
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/login';
        
        // 添加表单字段
        const fields = {
            'username': username,
            'password': password,
            'rememberMe': rememberMe ? 'true' : 'false',
            'returnUrl': returnUrl
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        // 添加到页面并提交
        document.body.appendChild(form);
        form.submit();
    };
</script>

