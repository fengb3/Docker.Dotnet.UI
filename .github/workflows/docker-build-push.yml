name: Build and Push Docker Image

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'Docker.Dotnet.UI/Docker.Dotnet.UI.csproj'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  IMAGE_NAME: fengb3/docker-dotnet-ui

jobs:
  check-version-changed:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä»¥ä¾¿æ¯”è¾ƒ

      - name: æ£€æŸ¥ Version æ˜¯å¦å˜åŠ¨
        id: check
        run: |
          # è·å–å½“å‰æäº¤å’Œä¸Šä¸€æ¬¡æäº¤çš„ Version å€¼
          CURRENT_VERSION=$(grep -oP '<Version>\K[^<]+' Docker.Dotnet.UI/Docker.Dotnet.UI.csproj)
          
          # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æäº¤æˆ–è€…æ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™è®¤ä¸ºç‰ˆæœ¬å·²å˜æ›´
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            PREVIOUS_VERSION=$(git show HEAD~1:Docker.Dotnet.UI/Docker.Dotnet.UI.csproj | grep -oP '<Version>\K[^<]+' || echo "")
            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "âœ… Version å·²å˜æ›´: $PREVIOUS_VERSION -> $CURRENT_VERSION"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Version æœªå˜æ›´: $CURRENT_VERSION"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… é¦–æ¬¡æäº¤æˆ–æ— æ³•æ¯”è¾ƒï¼Œç»§ç»­æ„å»º"
          fi

      - name: æå–ç‰ˆæœ¬å·
        id: extract
        run: |
          VERSION=$(grep -oP '<Version>\K[^<]+' Docker.Dotnet.UI/Docker.Dotnet.UI.csproj)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æå–åˆ°çš„ç‰ˆæœ¬å·: $VERSION"

  build-and-push:
    needs: check-version-changed
    if: needs.check-version-changed.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        if: vars.DOCKERHUB_REGISTRY != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.DOCKERHUB_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ç™»å½• GitHub Container Registry
        if: vars.GHCR_REGISTRY != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç™»å½•è‡ªå®šä¹‰é•œåƒä»“åº“ 1
        if: vars.CUSTOM_REGISTRY_1 != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.CUSTOM_REGISTRY_1 }}
          username: ${{ secrets.CUSTOM_REGISTRY_1_USERNAME }}
          password: ${{ secrets.CUSTOM_REGISTRY_1_PASSWORD }}

      - name: ç™»å½•è‡ªå®šä¹‰é•œåƒä»“åº“ 2
        if: vars.CUSTOM_REGISTRY_2 != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.CUSTOM_REGISTRY_2 }}
          username: ${{ secrets.CUSTOM_REGISTRY_2_USERNAME }}
          password: ${{ secrets.CUSTOM_REGISTRY_2_PASSWORD }}

      - name: æ„å»º Docker é•œåƒæ ‡ç­¾
        id: meta
        run: |
          set -euo pipefail
          VERSION="${{ needs.check-version-changed.outputs.version }}"
          TAGS=""

          add_tag() {
            TAGS="${TAGS}$1\n"
          }

          # Docker Hub
          if [ -n "${{ vars.DOCKERHUB_REGISTRY }}" ]; then
            add_tag "${{ vars.DOCKERHUB_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            add_tag "${{ vars.DOCKERHUB_REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          fi

          # GitHub Container Registry
          if [ -n "${{ vars.GHCR_REGISTRY }}" ]; then
            add_tag "${{ vars.GHCR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            add_tag "${{ vars.GHCR_REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          fi

          # è‡ªå®šä¹‰é•œåƒä»“åº“ 1
          if [ -n "${{ vars.CUSTOM_REGISTRY_1 }}" ]; then
            add_tag "${{ vars.CUSTOM_REGISTRY_1 }}/${{ env.IMAGE_NAME }}:latest"
            add_tag "${{ vars.CUSTOM_REGISTRY_1 }}/${{ env.IMAGE_NAME }}:${VERSION}"
          fi

          # è‡ªå®šä¹‰é•œåƒä»“åº“ 2
          if [ -n "${{ vars.CUSTOM_REGISTRY_2 }}" ]; then
            add_tag "${{ vars.CUSTOM_REGISTRY_2 }}/${{ env.IMAGE_NAME }}:latest"
            add_tag "${{ vars.CUSTOM_REGISTRY_2 }}/${{ env.IMAGE_NAME }}:${VERSION}"
          fi

          # å¦‚æœæ²¡æœ‰é…ç½®ä»»ä½•ä»“åº“ï¼Œä½¿ç”¨é»˜è®¤æ ‡ç­¾
          if [ -z "$(echo -n "$TAGS")" ]; then
            add_tag "${{ env.IMAGE_NAME }}:latest"
            add_tag "${{ env.IMAGE_NAME }}:${VERSION}"
          fi

          # è¾“å‡ºä¸ºå¤šè¡Œ action è¾“å‡º
          # Trim possible trailing newline by using printf
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          printf "%b" "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ğŸ“ ç”Ÿæˆçš„æ ‡ç­¾:"
          printf "%b" "$TAGS"

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Docker.Dotnet.UI/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      # - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: ./Docker.Dotnet.UI/Dockerfile
      #     push: true
      #     tags: ${{ steps.meta.outputs.tags }}
      #     platforms: linux/amd64,linux/arm64
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      - name: æ„å»ºæ€»ç»“
        run: |
          echo "### ğŸ‰ Docker é•œåƒæ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬å·:** \`${{ needs.check-version-changed.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
          # Iterate newline-separated tags from the meta step
          IFS=$'\n'
          for tag in ${{ steps.meta.outputs.tags }}; do
            # skip empty lines
            if [ -n "$tag" ]; then
              echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
            fi
          done
          unset IFS

